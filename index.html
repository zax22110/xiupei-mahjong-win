<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, getDoc, getDocs } from 'firebase/firestore';
import { getAnalytics } from "firebase/analytics";
import { 
  Heart, Trophy, TrendingDown, MapPin, ChevronLeft, ChevronRight,
  Save, Trash2, X, Plus, AlertCircle, CheckCircle2, Dices, User,
  Users, Coffee, Edit3, BarChart2, Calendar as CalendarIcon, Award, Home, Loader2, ArrowLeft, BookOpen, RotateCcw,
  Download, Upload, CalendarDays, MessageSquare, StickyNote, PieChart, Calendar as CalendarIconLucide, List, Percent, Hash
} from 'lucide-react';

// --- Firebase 配置 ---
// 優先使用環境提供的變數，若無則使用使用者提供的金鑰
const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyAkJgwcJtWQ4F1TLEnWooWhx42esNkcDpw",
  authDomain: "xiupei-mahjong-win.firebaseapp.com",
  projectId: "xiupei-mahjong-win",
  storageBucket: "xiupei-mahjong-win.firebasestorage.app",
  messagingSenderId: "999100537674",
  appId: "1:999100537674:web:b878870518299cefaa3fb3",
  measurementId: "G-LLLC56Q59Y"
};

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 初始化 Analytics (可選)
let analytics;
if (typeof window !== "undefined") {
  analytics = getAnalytics(app);
}

const appId = typeof __app_id !== 'undefined' ? __app_id : 'mahjong-2026-v2';

const App = () => {
  // --- 基礎設定 ---
  const NAME_1 = "肅佩";
  const NAME_2 = "泓翰";

  // --- 狀態管理 ---
  const [user, setUser] = useState(null);
  const [view, setView] = useState('home'); 
  const [selectedPlayer, setSelectedPlayer] = useState(null); 
  const [allSessions, setAllSessions] = useState([]); 
  const [memoData, setMemoData] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [restoring, setRestoring] = useState(false);
  const [memoSaving, setMemoSaving] = useState(false);
  const [importing, setImporting] = useState(false);
  
  const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedDateStr, setSelectedDateStr] = useState(''); 
  const [editingSessions, setEditingSessions] = useState([]); 

  // 核心：刪除墓碑（防止即時監聽導致刪除的資料復活）
  const deletedIdsRef = useRef(new Set());

  const [reportMonth, setReportMonth] = useState('total');
  const [detailMonth, setDetailMonth] = useState('total'); 

  const fileInputRef = useRef(null);

  // --- 1. 自動身份認證 ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth Error", e); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- 2. 雲端同步 ---
  useEffect(() => {
    if (!user) return;
    setLoading(true);

    const sessionsCol = collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
    const unsubSessions = onSnapshot(sessionsCol, (snapshot) => {
      const data = [];
      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        if (deletedIdsRef.current.has(id)) return;
        data.push({ id, ...docSnap.data() });
      });
      // 依日期排序
      data.sort((a, b) => b.date.localeCompare(a.date));
      setAllSessions(data);
      setLoading(false);
    }, (err) => { 
      console.error("Snapshot Error", err);
      setLoading(false); 
    });

    const memoDoc = doc(db, 'artifacts', appId, 'public', 'data', 'app_memo', 'global_memo');
    const unsubMemo = onSnapshot(memoDoc, (docSnap) => {
      if (docSnap.exists()) setMemoData(docSnap.data().content);
    });

    return () => { unsubSessions(); unsubMemo(); };
  }, [user]);

  // --- 3. 數據統計邏輯 ---
  const allStats = useMemo(() => {
    const players = {}; 
    allSessions.forEach((session) => {
      const dateStr = session.date;
      const month = dateStr.split('-')[1];
      const opponentNames = session.players.map(p => p.name.trim()).filter(n => n !== "");

      session.players.forEach(p => {
        const name = p.name.trim();
        if (!name) return;
        if (!players[name]) {
          players[name] = { 
            win: 0, loss: 0, net: 0, sessions: 0, rounds: 0, 
            totalWins: 0, monthly: {}, history: [], 
            monthlySessions: {}, monthlyWins: {} 
          };
        }
        const amt = Number(p.amount || 0);
        players[name].sessions += 1;
        players[name].rounds += Number(session.rounds || 0);
        players[name].net += amt;
        
        if (amt > 0) {
          players[name].win += amt;
          players[name].totalWins += 1;
          players[name].monthlyWins[month] = (players[name].monthlyWins[month] || 0) + 1;
        } else if (amt < 0) {
          players[name].loss += Math.abs(amt);
        }
        
        players[name].monthly[month] = (players[name].monthly[month] || 0) + amt;
        players[name].monthlySessions[month] = (players[name].monthlySessions[month] || 0) + 1;
        players[name].history.push({
          id: session.id, date: dateStr, month, location: session.location || "未填寫", 
          rounds: session.rounds, stakes: session.stakes, amount: amt, note: session.note || "", 
          opponents: opponentNames.filter(n => n !== name)
        });
      });
    });
    return { players };
  }, [allSessions]);

  const coupleData = {
    [NAME_1]: allStats.players[NAME_1] || { win: 0, loss: 0, net: 0, sessions: 0, rounds: 0, history: [] },
    [NAME_2]: allStats.players[NAME_2] || { win: 0, loss: 0, net: 0, sessions: 0, rounds: 0, history: [] },
    familyNet: (allStats.players[NAME_1]?.net || 0) + (allStats.players[NAME_2]?.net || 0)
  };

  const daySummary = useMemo(() => {
    const summary = {};
    editingSessions.forEach(s => {
      s.players.forEach(p => {
        const name = p.name.trim();
        if (!name) return;
        if (!summary[name]) summary[name] = { net: 0, wins: 0, total: 0 };
        summary[name].net += (Number(p.amount) || 0);
        summary[name].total += 1;
        if (Number(p.amount) > 0) summary[name].wins += 1;
      });
    });
    return summary;
  }, [editingSessions]);

  // --- 4. 核心動作 ---

  const closeModal = () => {
    deletedIdsRef.current.clear();
    setIsModalOpen(false);
  };

  const deleteSessionImmediately = async (sessionId) => {
    if (deletedIdsRef.current.has(sessionId)) return;
    const isCloudSession = allSessions.some(s => s.id === sessionId);

    if (!isCloudSession) {
      setEditingSessions(prev => prev.filter(s => s.id !== sessionId));
      return;
    }

    if (!window.confirm('確定要永久刪除此場次嗎？')) return;

    try {
      setSaving(true);
      deletedIdsRef.current.add(sessionId);
      setEditingSessions(prev => prev.filter(s => s.id !== sessionId));
      setAllSessions(prev => prev.filter(s => s.id !== sessionId));
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId));
    } catch (e) {
      alert('刪除失敗：' + e.message);
      deletedIdsRef.current.delete(sessionId);
    } finally {
      setSaving(false);
    }
  };

  const handleRestore = async () => {
    if (!user) return;
    if (!window.confirm('確定要還原到上一步紀錄嗎？這會覆蓋目前的所有數據。')) return;
    setRestoring(true);
    try {
      const backupRef = doc(db, 'artifacts', appId, 'public', 'data', 'backups', 'last_state');
      const snap = await getDoc(backupRef);
      if (!snap.exists()) { alert('找不到備份紀錄。'); return; }
      const backupData = JSON.parse(snap.data().content);
      
      const currentDocs = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'sessions'));
      for (const d of currentDocs.docs) { await deleteDoc(d.ref); }

      deletedIdsRef.current.clear();
      for (const s of backupData) {
        const { id, ...rest } = s;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id), rest);
      }
      alert('還原成功！');
    } catch (e) { alert('還原失敗'); } finally { setRestoring(false); }
  };

  const saveToCloud = async () => {
    if (!user) return;
    for (const s of editingSessions) {
      const total = s.players.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
      if (total !== 0 && !deletedIdsRef.current.has(s.id)) {
        if (!window.confirm(`場次 "${s.location || '未命名'}" 的金額不平衡 (${total})，確定要儲存嗎？`)) return;
      }
    }

    setSaving(true);
    try {
      const backupRef = doc(db, 'artifacts', appId, 'public', 'data', 'backups', 'last_state');
      await setDoc(backupRef, { content: JSON.stringify(allSessions), timestamp: Date.now() });

      for (const s of editingSessions) {
        if (deletedIdsRef.current.has(s.id)) continue;
        const { id, ...rest } = s;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id), rest);
      }
      closeModal();
    } catch (e) { 
      console.error(e); 
      alert('儲存失敗');
    } finally { 
      setSaving(false); 
    }
  };

  const saveMemo = async () => {
    if (!user) return;
    setMemoSaving(true);
    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_memo', 'global_memo'), { content: memoData, updatedAt: Date.now() });
    } catch (e) { console.error(e); } finally { setMemoSaving(false); }
  };

  const openModal = (dayOrDateStr) => {
    let dateStr = '';
    if (typeof dayOrDateStr === 'number') {
      dateStr = `2026-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(dayOrDateStr).padStart(2, '0')}`;
    } else {
      dateStr = dayOrDateStr;
    }
    setSelectedDateStr(dateStr);
    
    const existing = allSessions.filter(s => s.date === dateStr);
    setEditingSessions(existing.length > 0 ? JSON.parse(JSON.stringify(existing)) : [{
      id: "new_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5), 
      date: dateStr, stakes: '30/10', location: '', rounds: 1, note: '',
      players: [{ name: NAME_1, amount: 0 }, { name: NAME_2, amount: 0 }, { name: '對手A', amount: 0 }, { name: '對手B', amount: 0 }]
    }]);
    setIsModalOpen(true);
  };

  const openToday = () => {
    const today = new Date();
    const dateStr = `2026-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    openModal(dateStr);
  };

  const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];

  if (loading || restoring) return (
    <div className="min-h-screen bg-[#F5E6D3] flex flex-col items-center justify-center gap-4">
      <Loader2 className="animate-spin text-[#8C7355]" size={48} />
      <p className="font-black text-[#8C7355] tracking-widest">{restoring ? '正在執行還原...' : '載入紀錄中...'}</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F5E6D3] text-[#4A3728] font-sans p-4 pb-32 overflow-x-hidden">
      <div className="max-w-3xl mx-auto">
        
        {/* Header */}
        <header className="relative flex items-center justify-center h-16 mb-8 pt-4">
          <div className="absolute left-0">
            <button 
                onClick={handleRestore}
                className="w-10 h-10 flex items-center justify-center bg-white text-[#8C7355] border border-[#E6D5C3] rounded-full shadow-sm hover:bg-[#F5E6D3] transition-all active:scale-90"
                title="返回上一步紀錄"
            >
                <RotateCcw size={18} />
            </button>
          </div>

          <div className="bg-white px-6 py-2.5 rounded-full shadow-sm border border-[#E6D5C3] flex items-center gap-2 z-10">
             <Coffee className="text-[#8C7355]" size={18} />
             <h1 className="text-base font-black text-[#4A3728] whitespace-nowrap tracking-tight">2026 麻將日誌</h1>
          </div>

          <div className="absolute right-0">
            <button 
                onClick={openToday} 
                className="w-10 h-10 flex items-center justify-center bg-[#8C7355] text-white rounded-full shadow-lg transition-all active:scale-90"
                title="快速新增紀錄"
            >
                <Plus size={18} strokeWidth={3} />
            </button>
          </div>
        </header>

        {/* --- Home View --- */}
        {view === 'home' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="bg-[#8C7355] rounded-[3rem] p-10 text-white shadow-xl flex flex-col items-center text-center relative overflow-hidden group">
              <div className="absolute top-0 right-0 p-6 opacity-10"><Heart size={100} fill="white" /></div>
              <p className="text-[10px] font-black tracking-widest opacity-60 mb-2 uppercase">Family 2026 Balance</p>
              <h2 className="text-5xl font-black mb-4 tracking-tighter">
                {coupleData.familyNet >= 0 ? `+$${coupleData.familyNet}` : `-$${Math.abs(coupleData.familyNet)}`}
              </h2>
              <div className="bg-white/20 px-5 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 mb-2">
                <CheckCircle2 size={12} /> 雲端數據已同步
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {[NAME_1, NAME_2].map((name) => {
                const data = coupleData[name];
                return (
                  <div key={name} onClick={() => { setSelectedPlayer(name); setView('report'); }} className="bg-white rounded-[2.5rem] p-8 shadow-sm border-b-8 border-[#E6D5C3] cursor-pointer hover:translate-y-[-2px] transition-all active:scale-95">
                    <div className="flex items-start justify-between mb-6">
                      <div className="flex items-center gap-3 pt-1">
                        <div className="p-2.5 bg-[#F5E6D3] text-[#8C7355] rounded-2xl shadow-inner"><User size={22} /></div>
                        <div><span className="font-black text-xl text-[#4A3728] block">{name}</span><span className="text-[10px] text-[#C4B19E] font-bold">年度表現</span></div>
                      </div>
                      <div className="text-right">
                        <span className="text-[10px] font-black text-[#C4B19E] uppercase block mb-1">總盈虧</span>
                        <div className={`text-3xl font-black tracking-tight ${data.net >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}`}>
                          {data.net > 0 ? `+${data.net}` : data.net}
                        </div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-6">
                      <div className="bg-[#FBF8F5] p-3 rounded-2xl text-center border border-[#F5E6D3]/50 shadow-inner">
                        <p className="text-[9px] text-[#C4B19E] font-black uppercase mb-1">累計贏錢</p>
                        <p className="text-lg font-black text-[#8C7355]">${data.win}</p>
                      </div>
                      <div className="bg-[#FBF8F5] p-3 rounded-2xl text-center border border-[#F5E6D3]/50 shadow-inner">
                        <p className="text-[9px] text-[#C4B19E] font-black uppercase mb-1">累計輸錢</p>
                        <p className="text-lg font-black text-[#A64B4B]">${data.loss}</p>
                      </div>
                    </div>
                    <div className="flex justify-between items-center text-[10px] px-1 pt-3 border-t border-dashed border-[#F5E6D3] font-black">
                      <div className="flex items-center gap-1.5 text-[#C4B19E]"><Dices size={12} /><span>{data.sessions} 場 / {data.rounds} 將</span></div>
                      <span className="text-[#C4B19E]">查看明細 {'>'}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* --- Calendar View --- */}
        {view === 'calendar' && (
          <div className="space-y-4 animate-in fade-in duration-500">
            <div className="bg-[#FFFDFB] rounded-[2.5rem] p-6 border-8 border-white shadow-sm">
              <div className="flex items-center justify-between mb-8">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] hover:bg-[#E6D5C3] transition-colors active:scale-90"><ChevronLeft size={20} /></button>
                <div className="text-center relative"><h2 className="text-lg font-black">{monthNames[currentDate.getMonth()]}</h2><p className="text-[9px] font-black text-[#C4B19E]">2026 CALENDAR</p></div>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] hover:bg-[#E6D5C3] transition-colors active:scale-90"><ChevronRight size={20} /></button>
              </div>
              <div className="grid grid-cols-7 gap-1">
                {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="text-center text-[10px] font-black text-[#C4B19E] mb-2 uppercase">{d}</div>)}
                {(() => {
                  const year = currentDate.getFullYear();
                  const month = currentDate.getMonth();
                  const days = new Date(year, month + 1, 0).getDate();
                  const startDay = new Date(year, month, 1).getDay();
                  const cells = [];
                  for (let i = 0; i < startDay; i++) cells.push(<div key={`empty-${i}`} className="h-24"></div>);
                  for (let d = 1; d <= days; d++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const sessions = allSessions.filter(s => s.date === dateKey);
                    const n1 = sessions.reduce((a, s) => a + (Number(s.players.find(p => p.name === NAME_1)?.amount) || 0), 0);
                    const n2 = sessions.reduce((a, s) => a + (Number(s.players.find(p => p.name === NAME_2)?.amount) || 0), 0);
                    cells.push(
                      <div key={d} onClick={() => openModal(d)} className={`h-24 border border-[#F5E6D3]/50 rounded-xl p-1 cursor-pointer transition-all active:scale-95 ${sessions.length > 0 ? 'bg-white ring-1 ring-[#8C7355]/20 shadow-sm' : 'bg-white/30 hover:bg-[#F5E6D3]/20'}`}>
                        <span className="text-[10px] font-black text-[#C4B19E]">{d}</span>
                        {sessions.length > 0 && (
                          <div className="mt-1 space-y-0.5 overflow-hidden">
                            <div className={`text-[7px] p-0.5 rounded truncate scale-90 origin-left ${n1 >= 0 ? 'bg-[#F0EAD6] text-[#8C7355]' : 'bg-[#FBEBEB] text-[#A64B4B]'}`}>
                              <span>佩</span> <span>{n1}</span>
                            </div>
                            <div className={`text-[7px] p-0.5 rounded truncate scale-90 origin-left ${n2 >= 0 ? 'bg-[#F0EAD6] text-[#8C7355]' : 'bg-[#FBEBEB] text-[#A64B4B]'}`}>
                              <span>翰</span> <span>{n2}</span>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  }
                  return cells;
                })()}
              </div>
            </div>
            
            <div className="flex gap-3 px-2">
                <button onClick={() => { const dataStr = JSON.stringify(allSessions, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `mahjong_diary_2026_backup.json`; link.click(); URL.revokeObjectURL(url); }} className="flex-1 py-4 bg-white border-2 border-[#F5E6D3] text-[#8C7355] rounded-[1.5rem] text-xs font-black shadow-sm active:scale-95 flex items-center justify-center gap-2"><Download size={16} /> 匯出備份</button>
                <button onClick={() => fileInputRef.current?.click()} disabled={importing} className="flex-1 py-4 bg-white border-2 border-[#F5E6D3] text-[#8C7355] rounded-[1.5rem] text-xs font-black shadow-sm active:scale-95 flex items-center justify-center gap-2"><Upload size={16} /> 匯入資料</button>
                <input type="file" ref={fileInputRef} onChange={(e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const importedData = JSON.parse(event.target.result); setImporting(true); for (const s of importedData) { const { id, ...rest } = s; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id), rest); } alert('匯入成功！數據已更新。'); } catch (err) { alert('匯入失敗：格式錯誤'); } finally { setImporting(false); } }; reader.readAsText(file); }} accept=".json" className="hidden" />
            </div>
          </div>
        )}

        {/* --- Report View --- */}
        {view === 'report' && (
          <div className="animate-in fade-in duration-500">
             {selectedPlayer ? (
               <div className="bg-[#FFFDFB] rounded-[2.5rem] p-6 border-8 border-white shadow-sm min-h-[60vh]">
                 <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
                   <div className="flex items-center gap-4">
                     <button onClick={() => setSelectedPlayer(null)} className="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] active:scale-90"><ArrowLeft size={20} /></button>
                     <div><h2 className="text-xl font-black text-[#4A3728]">{selectedPlayer} 的戰績</h2><p className="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest">Personal Performance</p></div>
                   </div>
                   <select value={detailMonth} onChange={e => setDetailMonth(e.target.value)} className="bg-[#F5E6D3] rounded-xl text-xs font-black border-none px-4 py-2 text-[#8C7355] shadow-sm cursor-pointer outline-none">
                     <option value="total">全年度成績</option>
                     {monthNames.map((m, i) => <option key={i} value={String(i + 1).padStart(2, '0')}>{m}</option>)}
                   </select>
                 </div>

                 <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                   {(() => {
                     const filtered = allStats.players[selectedPlayer]?.history.filter(h => detailMonth === 'total' || h.month === detailMonth) || [];
                     const stats = filtered.reduce((acc, curr) => {
                        acc.sessions += 1;
                        acc.rounds += Number(curr.rounds || 0);
                        acc.net += curr.amount;
                        if (curr.amount > 0) acc.wins += 1;
                        return acc;
                     }, { sessions: 0, rounds: 0, net: 0, wins: 0 });
                     const winRate = stats.sessions > 0 ? ((stats.wins / stats.sessions) * 100).toFixed(1) : "0.0";
                     return (
                        <>
                          <div className="bg-[#FBF8F5] p-4 rounded-3xl text-center border border-[#F5E6D3]/30"><p className="text-[8px] font-bold text-[#C4B19E] mb-1">場數</p><p className="text-xl font-black text-[#8C7355]">{stats.sessions}</p></div>
                          <div className="bg-[#FBF8F5] p-4 rounded-3xl text-center border border-[#F5E6D3]/30"><p className="text-[8px] font-bold text-[#C4B19E] mb-1">勝率</p><p className="text-xl font-black text-[#8C7355]">{winRate}%</p></div>
                          <div className="bg-[#FBF8F5] p-4 rounded-3xl text-center border border-[#F5E6D3]/30"><p className="text-[8px] font-bold text-[#C4B19E] mb-1">累計將數</p><p className="text-xl font-black text-[#8C7355]">{stats.rounds}</p></div>
                          <div className="bg-[#FBF8F5] p-4 rounded-3xl text-center border border-[#F5E6D3]/30"><p className="text-[8px] font-bold text-[#C4B19E] mb-1">淨盈虧</p><p className={`text-xl font-black ${stats.net >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}`}>{stats.net}</p></div>
                        </>
                     );
                   })()}
                 </div>

                 <div className="space-y-4">
                   {allStats.players[selectedPlayer]?.history.filter(h => detailMonth === 'total' || h.month === detailMonth).slice().reverse().map((h, i) => (
                     <div key={i} className="bg-white p-5 rounded-[2rem] border border-[#F5E6D3] shadow-sm">
                       <div className="flex justify-between items-start mb-3">
                         <div className="flex flex-col"><span className="text-xs font-black text-gray-700">{h.date}</span><span className="text-[9px] text-[#C4B19E]">地點：{h.location}</span></div>
                         <span className={`text-xl font-black ${h.amount >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}`}>
                           {h.amount > 0 ? `+${h.amount}` : h.amount}
                         </span>
                       </div>
                       <div className="flex items-center gap-2 mb-3 bg-[#FBF8F5] py-2 px-3 rounded-xl"><Users size={12} className="text-[#8C7355]" /><span className="text-[10px] text-gray-600 font-medium">{h.opponents.join('、')}</span></div>
                       <div className="flex flex-wrap gap-2 border-t border-dashed border-[#F5E6D3] pt-3">
                         <span className="text-[9px] bg-[#F5E6D3] px-3 py-1 rounded-full font-bold text-[#8C7355]">{h.rounds} 將</span>
                         <span className="text-[9px] bg-[#F5E6D3] px-3 py-1 rounded-full font-bold text-[#8C7355]">{h.stakes || '30/10'}</span>
                       </div>
                       {h.note && <div className="mt-3 p-3 bg-[#F0EAD6]/30 rounded-2xl border-l-4 border-[#8C7355] flex gap-2 items-start text-[10px] italic leading-relaxed"><span>「 {h.note} 」</span></div>}
                     </div>
                   ))}
                 </div>
               </div>
             ) : (
               <div className="bg-[#FFFDFB] rounded-[3rem] p-8 border-8 border-white shadow-sm">
                 <div className="flex justify-between items-center mb-8">
                   <div><h2 className="text-xl font-black">2026 雀神排行</h2><p className="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest">{reportMonth === 'total' ? '全年度總累積' : `${monthNames[parseInt(reportMonth)-1]} 榜`}</p></div>
                   <select value={reportMonth} onChange={e => setReportMonth(e.target.value)} className="bg-[#F5E6D3] rounded-xl text-xs font-black border-none px-4 py-2 text-[#8C7355] shadow-sm outline-none cursor-pointer">
                     <option value="total">全年度總覽</option>
                     {monthNames.map((m, i) => <option key={i} value={String(i + 1).padStart(2, '0')}>{m}</option>)}
                   </select>
                 </div>
                 
                 <div className="space-y-3 px-1">
                   <div className="grid grid-cols-12 px-4 py-2 text-[10px] font-black text-[#C4B19E] uppercase tracking-widest border-b border-[#F5E6D3] mb-2 text-center">
                     <div className="col-span-4 text-left">排名 / 玩家</div>
                     <div className="col-span-2 text-left px-1">場數</div>
                     <div className="col-span-3 text-left">勝率</div>
                     <div className="col-span-3 text-right">盈虧</div>
                   </div>
                   
                   {Object.entries(allStats.players)
                    .map(([name, data]) => ({ name, ...data }))
                    .filter(p => reportMonth === 'total' || p.monthlySessions[reportMonth] > 0)
                    .sort((a, b) => { 
                      const valA = reportMonth === 'total' ? a.net : (a.monthly[reportMonth] || 0);
                      const valB = reportMonth === 'total' ? b.net : (b.monthly[reportMonth] || 0);
                      return valB - valA; 
                    })
                    .map((p, idx) => {
                       const displayAmount = reportMonth === 'total' ? p.net : (p.monthly[reportMonth] || 0);
                       const displaySessions = reportMonth === 'total' ? p.sessions : (p.monthlySessions[reportMonth] || 0);
                       const currentWins = reportMonth === 'total' ? p.totalWins : (p.monthlyWins[reportMonth] || 0);
                       const winRate = displaySessions > 0 ? ((currentWins / displaySessions) * 100).toFixed(1) : "0.0";
                       
                       return (
                           <div key={p.name} onClick={() => setSelectedPlayer(p.name)} className={`grid grid-cols-12 items-center px-4 py-5 rounded-[2rem] border-2 cursor-pointer transition-all active:scale-95 ${idx === 0 ? 'bg-[#F0EAD6]/40 border-[#8C7355]/20 shadow-sm' : 'bg-white border-transparent shadow-sm'}`}>
                             <div className="col-span-4 flex items-center gap-2">
                               <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-black shrink-0 ${idx === 0 ? 'bg-[#8C7355] text-white shadow-md' : 'bg-[#F5E6D3] text-[#8C7355]'}`}>
                                 {idx + 1}
                               </div>
                               <span className="font-black text-[#4A3728] text-xs sm:text-sm truncate">{p.name}</span>
                             </div>
                             <div className="col-span-2 text-left px-1 font-black text-[#C4B19E] text-xs">{displaySessions}</div>
                             <div className="col-span-3 text-left">
                               <span className="text-[10px] font-black text-[#8C7355] px-1.5 py-0.5 bg-[#FBF8F5] rounded-lg border border-[#F5E6D3]">
                                 {winRate}%
                               </span>
                             </div>
                             <div className={`col-span-3 text-right font-black text-xs sm:text-sm ${displayAmount >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}`}>
                               {displayAmount > 0 ? `+${displayAmount}` : displayAmount}
                             </div>
                           </div>
                       );
                   })}
                 </div>
               </div>
             )}
          </div>
        )}

        {/* --- Memo View --- */}
        {view === 'memo' && (
          <div className="animate-in slide-in-from-bottom-6 duration-500">
            <div className="bg-[#FFFDFB] rounded-[3rem] p-8 border-8 border-white shadow-sm min-h-[70vh] flex flex-col">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-xl font-black flex items-center gap-2"><BookOpen className="text-[#8C7355]" /> 備忘錄</h2>
                  <p className="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest">Rules & Notes</p>
                </div>
                <button onClick={saveMemo} disabled={memoSaving} className="flex items-center gap-2 bg-[#8C7355] text-white px-6 py-2.5 rounded-full text-xs font-black shadow-lg active:scale-95 transition-all">
                  {memoSaving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />} 儲存變更
                </button>
              </div>
              <textarea 
                value={memoData} 
                onChange={(e) => setMemoData(e.target.value)} 
                className="w-full flex-1 bg-[#FBF8F5] border-2 border-[#F5E6D3] rounded-[2rem] p-8 text-sm font-medium leading-relaxed outline-none resize-none focus:ring-2 focus:ring-[#8C7355]/20 transition-all shadow-inner" 
                placeholder="在此輸入公約、特別規則或開局筆記..." 
              />
            </div>
          </div>
        )}

        {/* --- Navigation --- */}
        <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md px-6 py-4 rounded-full shadow-2xl border border-[#E6D5C3] flex gap-8 z-40">
          {[
            { id: 'home', icon: Home, label: '總覽' },
            { id: 'calendar', icon: CalendarIcon, label: '日誌' },
            { id: 'report', icon: BarChart2, label: '排行' },
            { id: 'memo', icon: BookOpen, label: '備忘' }
          ].map(item => (
            <button key={item.id} onClick={() => { setView(item.id); setSelectedPlayer(null); }} className={`flex flex-col items-center gap-1 transition-all ${view === item.id ? 'text-[#8C7355] scale-110' : 'text-[#D9C5B2]'}`}>
              <item.icon size={22} />
              <span className="text-[9px] font-black uppercase tracking-tight">{item.label}</span>
            </button>
          ))}
        </nav>
      </div>

      {/* --- Modal --- */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-[#4A3728]/60 backdrop-blur-sm flex items-center justify-center p-0 md:p-6 z-[1000] animate-in fade-in">
          <div className="bg-[#FFFDFB] w-full max-w-4xl h-full md:h-auto md:max-h-[90vh] md:rounded-[3.5rem] flex flex-col overflow-hidden shadow-2xl border-t-[12px] border-[#8C7355]">
            <div className="p-6 border-b border-[#F5E6D3] flex justify-between items-center bg-white shadow-sm">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-[#F5E6D3] rounded-full text-[#8C7355] shadow-inner"><CalendarDays size={20} /></div>
                <h3 className="text-xl font-black text-[#4A3728]">{selectedDateStr} 管理</h3>
              </div>
              <div className="flex gap-2">
                <button 
                  onClick={() => setEditingSessions([...editingSessions, { id: "new_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5), date: selectedDateStr, stakes: '30/10', location: '', rounds: 1, note: '', players: [{ name: NAME_1, amount: 0 }, { name: NAME_2, amount: 0 }, { name: '對手A', amount: 0 }, { name: '對手B', amount: 0 }] }])} 
                  className="bg-[#A67B5B] text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-md active:scale-95 font-black text-2xl" 
                >+</button>
                <button onClick={closeModal} className="bg-[#F5E6D3] p-2 rounded-full text-[#8C7355] active:scale-95 shadow-sm"><X size={20} /></button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-[#FBF8F5]">
              <div className="bg-white rounded-[2rem] p-6 border-2 border-[#8C7355]/20 shadow-sm">
                  <div className="flex items-center gap-2 mb-4"><PieChart size={18} className="text-[#8C7355]" /><h4 className="text-sm font-black text-[#8C7355] uppercase tracking-wider">戰績快報</h4></div>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                      {Object.entries(daySummary).map(([name, data]) => (
                        <div key={name} className="bg-[#FBF8F5] p-3 rounded-2xl border border-[#F5E6D3] flex flex-col items-center">
                          <span className="text-[9px] font-black text-[#C4B19E] mb-1">{name}</span>
                          <span className={`text-sm font-black ${data.net > 0 ? 'text-[#8C7355]' : data.net < 0 ? 'text-[#A64B4B]' : 'text-gray-400'}`}>
                            {data.net > 0 ? `+${data.net}` : data.net}
                          </span>
                        </div>
                      ))}
                  </div>
              </div>

              {editingSessions.map((session, sIdx) => {
                const totalAmount = session.players.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
                const isBalanced = totalAmount === 0;
                return (
                  <div key={session.id} className="bg-white rounded-[2rem] p-6 border-2 border-[#8C7355]/30 relative shadow-sm">
                    <button onClick={() => deleteSessionImmediately(session.id)} className="absolute -top-3 -right-3 bg-white text-rose-500 p-2.5 rounded-full shadow-lg border border-rose-100 active:scale-90 z-10"><Trash2 size={18} /></button>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                      <div className="col-span-2">
                        <label className="text-[10px] font-black text-[#C4B19E] mb-1 block uppercase tracking-widest">日期</label>
                        <div className="flex items-center gap-2 bg-[#F5E6D3]/30 p-2 rounded-xl border border-[#F5E6D3] shadow-inner">
                          <CalendarIconLucide size={14} className="text-[#8C7355]" />
                          <input type="date" value={session.date} onChange={e => { const nl = [...editingSessions]; nl[sIdx].date = e.target.value; setEditingSessions(nl); }} className="bg-transparent border-none text-[11px] font-black text-[#8C7355] focus:ring-0 p-0 w-full" />
                        </div>
                      </div>
                      <div>
                        <label className="text-[10px] font-black text-[#C4B19E] mb-1 block uppercase">底 / 台</label>
                        <div className="flex items-center gap-2 bg-[#F5E6D3]/30 p-2 rounded-xl border border-[#F5E6D3] shadow-inner">
                          <Hash size={12} className="text-[#8C7355]" />
                          <input type="text" value={session.stakes} placeholder="30/10" onChange={e => { const nl = [...editingSessions]; nl[sIdx].stakes = e.target.value; setEditingSessions(nl); }} className="bg-transparent border-none text-xs font-black w-full focus:ring-0 p-0" />
                        </div>
                      </div>
                      <div>
                        <label className="text-[10px] font-black text-[#C4B19E] mb-1 block uppercase">將數</label>
                        <input type="number" value={session.rounds} onChange={e => { const nl = [...editingSessions]; nl[sIdx].rounds = e.target.value; setEditingSessions(nl); }} className="w-full bg-[#F5E6D3]/30 border-none rounded-xl px-4 py-2 text-xs font-black shadow-inner" />
                      </div>
                    </div>
                    
                    <div className="mb-4">
                       <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {session.players.map((p, pIdx) => (
                          <div key={pIdx} className={`flex items-center gap-2 p-3 rounded-2xl border-2 ${pIdx < 2 ? 'bg-[#F5E6D3]/10 border-[#F5E6D3]/50' : 'bg-[#FBF8F5] border-transparent shadow-inner'}`}>
                            <input type="text" value={p.name} onChange={e => { const nl = [...editingSessions]; nl[sIdx].players[pIdx].name = e.target.value; setEditingSessions(nl); }} className="flex-1 bg-transparent border-none text-xs font-black focus:ring-0 text-[#4A3728]" placeholder="姓名" />
                            <div className="bg-white px-3 py-1.5 rounded-xl flex items-center shadow-sm border border-gray-100">
                              <span className="text-[10px] text-[#C4B19E] mr-1">$</span>
                              <input type="number" value={p.amount} onChange={e => { const nl = [...editingSessions]; nl[sIdx].players[pIdx].amount = e.target.value; setEditingSessions(nl); }} className={`w-16 bg-transparent border-none text-right font-black text-xs focus:ring-0 ${Number(p.amount) > 0 ? 'text-[#8C7355]' : Number(p.amount) < 0 ? 'text-[#A64B4B]' : 'text-gray-400'}`} />
                            </div>
                          </div>
                        ))}
                       </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-[#F5E6D3] pt-4 mt-2">
                       <div className="space-y-2">
                         <label className="flex items-center gap-2 text-[10px] font-black text-[#8C7355] uppercase"><MessageSquare size={12}/> 筆記</label>
                         <textarea value={session.note} onChange={e => { const nl = [...editingSessions]; nl[sIdx].note = e.target.value; setEditingSessions(nl); }} className="w-full bg-[#F5E6D3]/20 border-2 border-dashed border-[#F5E6D3] rounded-2xl p-4 text-[11px] font-medium transition-all resize-none h-20 outline-none" placeholder="紀錄筆記..." />
                       </div>
                       <div className="flex flex-col justify-end gap-3">
                          <div className={`px-6 py-2.5 rounded-full inline-flex items-center justify-between gap-2 text-[10px] font-black ${isBalanced ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-rose-50 text-rose-500 border border-rose-100'}`}>
                            <div className="flex items-center gap-2">{isBalanced ? <CheckCircle2 size={14}/> : <AlertCircle size={14}/>} <span>核算：{totalAmount}</span></div>
                          </div>
                          <div className="p-2 bg-[#FBF8F5] rounded-xl border border-[#F5E6D3]">
                            <label className="text-[9px] font-black text-[#C4B19E] block mb-1">地點</label>
                            <input type="text" value={session.location} onChange={e => { const nl = [...editingSessions]; nl[sIdx].location = e.target.value; setEditingSessions(nl); }} className="w-full bg-transparent border-none p-0 text-xs font-black focus:ring-0" placeholder="未填寫" />
                          </div>
                       </div>
                    </div>
                  </div>
                );
              })}
            </div>
            
            <div className="p-4 bg-white border-t border-[#F5E6D3] shadow-lg">
              <button onClick={saveToCloud} disabled={saving} className="w-full py-4 bg-[#8C7355] text-white rounded-[2rem] font-black shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all">
                {saving ? <Loader2 size={20} className="animate-spin" /> : <Save size={20} />} 儲存變更
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
