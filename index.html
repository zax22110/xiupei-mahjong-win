<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 麻將日誌</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 圖示 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS 匯出 Excel 用 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F5E6D3;
            color: #4A3728;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .select-custom {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238C7355' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em;
        }
        .player-preset-btn.active {
            background-color: #8C7355 !important;
            color: white !important;
            border-color: #8C7355 !important;
        }
        .nav-text-wrap {
            width: 2.2em;
            line-height: 1.1;
            text-align: center;
        }
        /* 計算機樣式 */
        .calc-btn {
            @apply flex items-center justify-center bg-white border border-[#E6D5C3] rounded-2xl h-14 text-xl font-black active:bg-[#F5E6D3] transition-all shadow-sm;
        }
        .calc-btn-op {
            @apply bg-[#F5E6D3] text-[#8C7355];
        }
        .calc-btn-confirm {
            @apply bg-[#8C7355] text-white shadow-md;
        }
    </style>
</head>
<body class="pb-32 overflow-x-hidden text-sm sm:text-base">

    <div id="app" class="max-w-3xl mx-auto p-4">
        <!-- 載入中遮罩 -->
        <div id="loading-overlay" class="fixed inset-0 z-[2000] bg-[#F5E6D3] flex flex-col items-center justify-center gap-4 transition-opacity duration-500">
            <div class="w-12 h-12 border-4 border-[#8C7355] border-t-transparent rounded-full animate-spin"></div>
            <p id="loading-text" class="font-black text-[#8C7355] tracking-widest text-center text-sm">正在同步雲端數據...</p>
        </div>

        <!-- 頂部導覽 -->
        <header class="relative flex items-center justify-center h-16 mb-8 pt-4">
            <div class="absolute left-0">
                <button onclick="window.handleRestore()" class="w-10 h-10 flex items-center justify-center bg-white text-[#8C7355] border border-[#E6D5C3] rounded-full shadow-sm hover:bg-[#F5E6D3] transition-all active:scale-90" title="還原備份">
                    <i data-lucide="rotate-ccw" class="w-[18px]"></i>
                </button>
            </div>
            <div class="bg-white px-6 py-2.5 rounded-full shadow-sm border border-[#E6D5C3] flex items-center gap-2 z-10">
                <i data-lucide="coffee" class="text-[#8C7355] w-[18px]"></i>
                <h1 class="text-base font-black text-[#4A3728] whitespace-nowrap tracking-tight">2026 麻將日誌</h1>
            </div>
            <div class="absolute right-0">
                <button onclick="window.openToday()" class="w-10 h-10 flex items-center justify-center bg-[#8C7355] text-white rounded-full shadow-lg transition-all active:scale-90" title="新增紀錄">
                    <i data-lucide="plus" class="w-[18px]" style="stroke-width: 3px;"></i>
                </button>
            </div>
        </header>

        <!-- 主要內容區 -->
        <main id="view-container" class="animate-in"></main>

        <!-- 底部導覽列 -->
        <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur-md px-3 sm:px-6 py-4 rounded-full shadow-2xl border border-[#E6D5C3] flex gap-2.5 sm:gap-6 z-40 text-center items-center">
            <button onclick="window.switchView('home')" id="nav-home" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="layout-dashboard" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase">總覽</span>
            </button>
            <button onclick="window.switchView('calendar')" id="nav-calendar" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="calendar" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase">麻將</span>
            </button>
            <button onclick="window.switchView('report', true)" id="nav-report" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="bar-chart-3" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase nav-text-wrap">麻將排行</span>
            </button>
            <button onclick="window.switchView('reddot')" id="nav-reddot" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="gamepad-2" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase">紅點</span>
            </button>
            <button onclick="window.switchView('reddot_rank')" id="nav-reddot_rank" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="award" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase nav-text-wrap">紅點排行</span>
            </button>
            <button onclick="window.switchView('memo')" id="nav-memo" class="flex flex-col items-center gap-1.5 transition-all text-[#D9C5B2] min-w-[2.2rem]">
                <i data-lucide="book-open" class="w-[18px] sm:w-[20px]"></i>
                <span class="text-[8px] font-black uppercase">備忘</span>
            </button>
        </nav>
    </div>

    <!-- 彈窗 Modal -->
    <div id="modal-root" class="hidden fixed inset-0 z-[1000] bg-[#4A3728]/60 backdrop-blur-sm flex items-center justify-center p-0 md:p-6 animate-in">
        <div id="modal-content" class="bg-[#FFFDFB] w-full max-w-4xl h-full md:h-auto md:max-h-[90vh] md:rounded-[3.5rem] flex flex-col overflow-hidden shadow-2xl border-t-[12px] border-[#8C7355]">
        </div>
    </div>

    <!-- 計算機 Modal -->
    <div id="calc-modal" class="hidden fixed inset-0 z-[2000] bg-[#4A3728]/80 backdrop-blur-md flex items-end justify-center animate-in">
        <div class="bg-[#FFFDFB] w-full max-w-md rounded-t-[3rem] p-8 space-y-6 shadow-2xl border-t-8 border-[#8C7355]">
            <div class="flex justify-between items-center px-2 text-[#8C7355]">
                <p class="font-black text-xs uppercase tracking-widest leading-none">金額計算機</p>
                <button onclick="window.closeCalculator()"><i data-lucide="x-circle"></i></button>
            </div>
            <div class="bg-[#FBF8F5] rounded-3xl p-6 border-2 border-[#F5E6D3] shadow-inner text-right min-h-[5rem] flex flex-col justify-center">
                <div id="calc-display" class="text-3xl font-black text-[#4A3728] tracking-tighter truncate">0</div>
            </div>
            <div class="grid grid-cols-4 gap-3 pb-8">
                <button onclick="window.pressCalc('C')" class="calc-btn calc-btn-op text-sm">清除</button>
                <button onclick="window.pressCalc('/')" class="calc-btn calc-btn-op">/</button>
                <button onclick="window.pressCalc('*')" class="calc-btn calc-btn-op">×</button>
                <button onclick="window.pressCalc('back')" class="calc-btn calc-btn-op"><i data-lucide="delete"></i></button>
                <button onclick="window.pressCalc('7')" class="calc-btn">7</button>
                <button onclick="window.pressCalc('8')" class="calc-btn">8</button>
                <button onclick="window.pressCalc('9')" class="calc-btn">9</button>
                <button onclick="window.pressCalc('-')" class="calc-btn calc-btn-op">-</button>
                <button onclick="window.pressCalc('4')" class="calc-btn">4</button>
                <button onclick="window.pressCalc('5')" class="calc-btn">5</button>
                <button onclick="window.pressCalc('6')" class="calc-btn">6</button>
                <button onclick="window.pressCalc('+')" class="calc-btn calc-btn-op">+</button>
                <button onclick="window.pressCalc('1')" class="calc-btn">1</button>
                <button onclick="window.pressCalc('2')" class="calc-btn">2</button>
                <button onclick="window.pressCalc('3')" class="calc-btn">3</button>
                <button onclick="window.pressCalc('=')" class="calc-btn calc-btn-op">=</button>
                <button onclick="window.pressCalc('0')" class="calc-btn col-span-2">0</button>
                <button onclick="window.pressCalc('.')" class="calc-btn">.</button>
                <button onclick="window.applyCalculator()" class="calc-btn calc-btn-confirm"><i data-lucide="check"></i></button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-10 left-1/2 -translate-x-1/2 z-[3000] bg-[#4A3728] text-white px-8 py-3 rounded-full shadow-2xl font-bold transition-all text-sm"></div>
    <input type="file" id="file-input" class="hidden" accept=".json">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkJgwcJtWQ4F1TLEnWooWhx42esNkcDpw",
            authDomain: "xiupei-mahjong-win.firebaseapp.com",
            projectId: "xiupei-mahjong-win",
            storageBucket: "xiupei-mahjong-win.firebasestorage.app",
            messagingSenderId: "999100537674",
            appId: "1:999100537674:web:b878870518299cefaa3fb3",
            measurementId: "G-LLLC56Q59Y"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mahjong-2026-v2';

        const NAME_1 = "肅佩";
        const NAME_2 = "泓翰";
        const RED_DOT_PRESETS = ["肅佩", "泓翰", "祥一", "靜譊", "阿鄉"];
        const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];

        let state = {
            user: null, view: 'home', allSessions: [], redDotSessions: [], memoData: '',
            currentDate: new Date(2026, 0, 1), selectedPlayer: null, deletedIds: new Set(),
            editingSessions: [], editingRedDot: null, selectedDateStr: '',
            reportMonth: 'total', detailMonth: 'total', isModalOpen: false, rankFilterLocations: [],
            calc: { target: null, expression: '' }
        };
        window.state = state;

        // --- 修正：數據清理 (Firestore 不允許 undefined) ---
        const cleanData = (data) => JSON.parse(JSON.stringify(data));

        // --- 1. 核心邏輯：功能函式預掛載 ---

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if (t) { t.textContent = msg; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        };

        window.calculateStats = (locs = [], targetM = 'total') => {
            const players = {};
            state.allSessions.forEach(s => {
                const m = s.date.split('-')[1]; const l = s.location || "未填寫";
                if (targetM !== 'total' && m !== targetM) return;
                if (locs.length > 0 && !locs.includes(l)) return;
                s.players.forEach(p => {
                    const n = p.name.trim(); if (!n) return;
                    if (!players[n]) players[n] = { win: 0, loss: 0, net: 0, sessions: 0, rounds: 0, history: [], monthly: {}, monthlySessions: {} };
                    const amt = Number(p.amount || 0);
                    players[n].sessions += 1; players[n].rounds += Number(s.rounds || 0); players[n].net += amt;
                    if (amt > 0) { players[n].win += amt; } else if (amt < 0) { players[n].loss += Math.abs(amt); }
                    players[n].history.push({ id: s.id, date: s.date, month: m, location: l, rounds: s.rounds, amount: amt, note: s.note || "", opponents: s.players.map(x=>x.name).filter(x=>x!==n) });
                });
            });
            return players;
        };

        window.calculateRedDotRanking = () => {
            const players = {};
            state.redDotSessions.forEach(s => { s.players.forEach(p => { if (!players[p.name]) players[p.name] = { net: 0, sessions: 0 }; players[p.name].net += Number(p.amount || 0); players[p.name].sessions += 1; }); });
            return players;
        };

        window.switchView = (v, reset = true) => {
            state.view = v; if (reset) { state.selectedPlayer = null; state.reportMonth = 'total'; state.rankFilterLocations = []; }
            window.render();
        };

        window.closeModal = () => { state.deletedIds.clear(); state.editingRedDot = null; document.getElementById('modal-root').classList.add('hidden'); };
        window.closeCalculator = () => document.getElementById('calc-modal').classList.add('hidden');

        window.openCalculator = (info) => { 
            state.calc.target = info; state.calc.expression = ''; 
            document.getElementById('calc-display').textContent = '0'; 
            document.getElementById('calc-modal').classList.remove('hidden'); 
            lucide.createIcons(); 
        };

        window.pressCalc = (v) => {
            const disp = document.getElementById('calc-display');
            if (v === 'C') state.calc.expression = '';
            else if (v === 'back') state.calc.expression = state.calc.expression.slice(0, -1);
            else if (v === '=') { try { state.calc.expression = String(eval(state.calc.expression.replace(/×/g, '*').replace(/÷/g, '/'))); } catch (e) { state.calc.expression = 'Error'; } }
            else state.calc.expression += v;
            disp.textContent = state.calc.expression || '0';
        };

        window.applyCalculator = () => {
            try {
                const val = eval(state.calc.expression) || 0; const { type, sIdx, pIdx } = state.calc.target;
                if (type === 'mahjong') { state.editingSessions[sIdx].players[pIdx].amount = Number(val); window.renderModal(); }
                else if (type === 'reddot') { state.editingRedDot.players[pIdx].amount = Number(val); window.renderRedDotModal(); }
                window.closeCalculator();
            } catch (e) { window.showToast("計算錯誤"); }
        };

        // --- 2. 視圖渲染核心 ---

        window.renderStatBox = (l, v, c, bg = 'bg-[#FBF8F5]') => `<div class="${bg} p-3 rounded-3xl border border-[#F5E6D3]/30 shadow-inner text-center"><p class="text-[8px] font-bold text-[#C4B19E] mb-1 uppercase tracking-widest">${l}</p><p class="text-lg font-black ${c}">${v}</p></div>`;

        window.renderImportExportButtons = (type) => `<div class="flex flex-wrap gap-2 px-2 mt-4"><button onclick="window.importTrigger()" class="flex-1 min-w-[90px] py-3 bg-white border-2 border-[#F5E6D3] text-[#8C7355] rounded-2xl text-[10px] font-black active:scale-95 flex items-center justify-center gap-1.5 transition-all shadow-sm"><i data-lucide="upload" size="14"></i> 匯入</button><button onclick="window.exportData()" class="flex-1 min-w-[90px] py-3 bg-white border-2 border-[#F5E6D3] text-[#8C7355] rounded-2xl text-[10px] font-black active:scale-95 flex items-center justify-center gap-1.5 transition-all shadow-sm"><i data-lucide="download" size="14"></i> 匯出</button><button onclick="window.exportExcel('${type}')" class="flex-1 min-w-[100px] py-3 bg-[#8C7355] text-white rounded-2xl text-[10px] font-black active:scale-95 flex items-center justify-center gap-1.5 shadow-md hover:opacity-90 transition-all"><i data-lucide="file-spreadsheet" size="14"></i> Excel</button></div>`;

        window.renderHome = (container) => {
            const statsM = window.calculateStats(); const statsR = window.calculateRedDotRanking();
            const getComb = (n) => { const m = statsM[n]?.net || 0; const r = statsR[n]?.net || 0; return { m, r, total: m + r, sess: statsM[n]?.sessions || 0 }; };
            const p1 = getComb(NAME_1); const p2 = getComb(NAME_2); const famTotal = p1.total + p2.total;
            container.innerHTML = `<div class="space-y-6 animate-in"><div class="bg-gradient-to-br from-[#8C7355] to-[#5D4B37] rounded-[3rem] p-10 text-white shadow-xl text-center relative overflow-hidden group"><div class="absolute top-0 right-0 p-6 opacity-10"><i data-lucide="heart" size="120" fill="white"></i></div><p class="text-[10px] font-black tracking-widest opacity-60 mb-2 uppercase text-center">Family 2026 Combined</p><h2 class="text-5xl font-black mb-4 tracking-tighter text-center">${famTotal >= 0 ? '+' : ''}$${famTotal}</h2><div class="bg-white/20 px-5 py-1.5 rounded-full text-xs font-bold inline-flex items-center gap-2 mb-2 shadow-sm leading-none mx-auto"><i data-lucide="check-circle-2" size="12"></i> 雲端數據同步中</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">${[NAME_1, NAME_2].map(name => { const d = getComb(name); return `<div onclick="window.state.selectedPlayer='${name}'; window.state.detailMonth='total'; window.switchView('report', false)" class="bg-white rounded-[3rem] p-8 shadow-sm border-b-8 border-[#E6D5C3] cursor-pointer hover:translate-y-[-4px] transition-all active:scale-95 relative overflow-hidden"><div class="flex items-center gap-4 mb-8 text-left"><div class="p-3 bg-[#F5E6D3] text-[#8C7355] rounded-[1.5rem] shadow-inner"><i data-lucide="user" size="24"></i></div><div><span class="font-black text-2xl text-[#4A3728] block leading-tight">${name}</span><span class="text-[10px] text-[#C4B19E] font-black uppercase tracking-widest mt-1 block leading-none text-left">Personal Balance</span></div></div><div class="space-y-3 mb-8"><div class="flex justify-between items-center bg-[#FBF8F5] p-3 rounded-[1.5rem] border border-[#F5E6D3]/40"><div class="flex items-center gap-2.5"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-sm"><i data-lucide="dices" size="16" class="text-[#8C7355]"></i></div><span class="text-xs font-black text-[#8C7355]">麻將盈虧</span></div><span class="text-sm font-black ${d.m >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${d.m >= 0 ? '+' : ''}${d.m}</span></div><div class="flex justify-between items-center bg-[#FBF8F5] p-3 rounded-[1.5rem] border border-[#F5E6D3]/40"><div class="flex items-center gap-2.5"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-sm"><i data-lucide="spade" size="16" class="text-[#8C7355]"></i></div><span class="text-xs font-black text-[#8C7355]">紅點盈虧</span></div><span class="text-sm font-black ${d.r >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${d.r >= 0 ? '+' : ''}${d.r}</span></div><div class="flex justify-between items-center bg-[#8C7355] p-5 rounded-[2.2rem] shadow-lg transform scale-[1.03]"><div class="flex items-center gap-3 text-white font-black"><div class="p-2 bg-white/20 rounded-xl text-white"><i data-lucide="wallet" size="20"></i></div><span class="text-xs uppercase tracking-widest leading-none">合計結算</span></div><span class="text-2xl font-black text-white">${d.total >= 0 ? '+' : ''}${d.total}</span></div></div><div class="flex justify-between items-center text-[11px] font-black text-[#C4B19E] pt-2 border-t border-dashed border-[#F5E6D3]"><span>參戰 ${d.sess} 場麻將</span><span>詳情 ></span></div></div>`; }).join('')}</div></div>`;
            lucide.createIcons();
        };

        window.renderCalendar = (container) => {
            const y = state.currentDate.getFullYear(); const m = state.currentDate.getMonth(); const days = new Date(y, m+1, 0).getDate(); const start = new Date(y, m, 1).getDay();
            let grid = ''; for (let i = 0; i < start; i++) grid += '<div class="h-24"></div>';
            for (let d = 1; d <= days; d++) {
                const dk = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const sess = state.allSessions.filter(s => s.date === dk);
                const n1 = sess.reduce((a, s) => a + (Number(s.players.find(p => p.name === NAME_1)?.amount) || 0), 0);
                const n2 = sess.reduce((a, s) => a + (Number(s.players.find(p => p.name === NAME_2)?.amount) || 0), 0);
                grid += `<div onclick="window.openModal('${dk}')" class="h-24 border border-[#F5E6D3]/50 rounded-xl p-1 cursor-pointer transition-all active:scale-95 ${sess.length > 0 ? 'bg-white ring-1 ring-[#8C7355]/20 shadow-sm' : 'bg-white/30 hover:bg-[#F5E6D3]/20'}"><span class="text-[10px] font-black text-[#C4B19E]">${d}</span>${sess.length > 0 ? `<div class="mt-1 space-y-0.5 overflow-hidden"><div class="text-[7px] p-0.5 rounded truncate scale-90 origin-left ${n1>=0?'bg-[#F0EAD6] text-[#8C7355]':'bg-[#FBEBEB] text-[#A64B4B]'}"><span>佩</span> <span>${n1}</span></div><div class="text-[7px] p-0.5 rounded truncate scale-90 origin-left ${n2>=0?'bg-[#F0EAD6] text-[#8C7355]':'bg-[#FBEBEB] text-[#A64B4B]'}"><span>翰</span> <span>${n2}</span></div></div>` : ''}</div>`;
            }
            container.innerHTML = `<div class="space-y-4 animate-in"><div class="bg-[#FFFDFB] rounded-[2.5rem] p-6 border-8 border-white shadow-sm"><div class="flex items-center justify-between mb-8"><button onclick="window.changeMonth(-1)" class="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] active:scale-90"><i data-lucide="chevron-left" size="20"></i></button><div class="text-center"><h2 class="text-lg font-black">${monthNames[m]}</h2><p class="text-[9px] font-black text-[#C4B19E]">MAHJONG RECORD</p></div><button onclick="window.changeMonth(1)" class="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] active:scale-90"><i data-lucide="chevron-right" size="20"></i></button></div><div class="grid grid-cols-7 gap-1 text-[#C4B19E] font-black text-[10px] mb-2 text-center uppercase">${['日','一','二','三','四','五','六'].map(d=>`<div>${d}</div>`).join('')}${grid}</div></div>${window.renderImportExportButtons('mahjong')}</div>`;
            lucide.createIcons();
        };

        window.renderRedDot = (container) => {
            container.innerHTML = `<div class="space-y-4 animate-in"><div class="bg-[#FFFDFB] rounded-[2.5rem] p-8 border-8 border-white shadow-sm min-h-[70vh]"><div class="flex justify-between items-center mb-8"><div><h2 class="text-xl font-black text-[#4A3728]">紅點紀錄</h2><p class="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest text-[#8C7355]">Game Log</p></div><button onclick="window.createNewRedDot()" class="bg-[#8C7355] text-white px-6 py-2.5 rounded-full text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 transition-all hover:bg-[#5D4B37]"><i data-lucide="plus" size="16"></i> 新增對局</button></div><div class="space-y-4">${state.redDotSessions.map(s => `<div onclick="window.editRedDot('${s.id}')" class="bg-white p-5 rounded-[2.5rem] border-2 border-[#F5E6D3] shadow-sm cursor-pointer hover:border-[#8C7355] transition-all group"><div class="flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-[#F5E6D3] rounded-full flex items-center justify-center text-[#8C7355]"><i data-lucide="calendar" size="18"></i></div><div><p class="text-xs font-black text-[#4A3728]">${s.date}</p><p class="text-[9px] text-[#C4B19E] font-black uppercase">結算紀錄</p></div></div><i data-lucide="chevron-right" class="text-[#C4B19E] group-hover:text-[#8C7355] transition-all"></i></div><div class="grid grid-cols-4 gap-1.5 sm:gap-2">${s.players.map(p => `<div class="bg-[#FBF8F5] p-1.5 rounded-xl border border-[#F5E6D3] flex flex-col items-center justify-center min-w-0"><p class="text-[8px] font-black text-[#C4B19E] truncate uppercase w-full text-center leading-none mb-1 text-[#C4B19E]">${p.name}</p><p class="text-[10px] font-black ${p.amount >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'} truncate w-full text-center">${p.amount >= 0 ? '+' : ''}${p.amount}</p></div>`).join('')}</div></div>`).join('')}</div></div>${window.renderImportExportButtons('reddot')}</div>`;
            lucide.createIcons();
        };

        window.renderReport = (container) => {
            const stats = window.calculateStats(state.rankFilterLocations, state.reportMonth);
            if (state.selectedPlayer && stats[state.selectedPlayer]) {
                const p = stats[state.selectedPlayer]; const hist = p.history.filter(h => state.detailMonth === 'total' || h.month === state.detailMonth);
                const s = hist.reduce((acc, curr) => { acc.sess++; acc.rds += Number(curr.rounds); acc.net += curr.amount; if (curr.amount > 0) acc.wins++; return acc; }, { sess: 0, rds: 0, net: 0, wins: 0 });
                container.innerHTML = `<div class="bg-[#FFFDFB] rounded-[2.5rem] p-6 border-8 border-white shadow-sm min-h-[60vh] animate-in"><div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8"><div class="flex items-center gap-4"><button onclick="window.state.selectedPlayer=null; window.render()" class="p-2 bg-[#F5E6D3] rounded-xl text-[#8C7355] active:scale-90"><i data-lucide="arrow-left" size="20"></i></button><div><h2 class="text-xl font-black">${state.selectedPlayer}</h2><p class="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest">Personal Performance</p></div></div><select onchange="window.state.detailMonth=this.value; window.render()" class="bg-[#F5E6D3] rounded-xl text-xs font-black px-4 py-2 text-[#8C7355] border-none outline-none select-custom shadow-sm"><option value="total">全年度成績</option>${monthNames.map((m, i) => `<option value="${String(i+1).padStart(2,'0')}" ${state.detailMonth === String(i+1).padStart(2,'0') ? 'selected' : ''}>${m}</option>`).join('')}</select></div><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8 text-center">${window.renderStatBox("場數", s.sess, 'text-[#8C7355]')}${window.renderStatBox("勝率", (s.sess > 0 ? (s.wins/s.sess*100).toFixed(1) : 0) + "%", 'text-[#8C7355]')}${window.renderStatBox("將數", s.rds, 'text-[#8C7355]')}${window.renderStatBox("淨盈虧", s.net, s.net < 0 ? 'text-[#A64B4B]' : 'text-[#8C7355]', 'bg-[#FBF8F5]')}</div><div class="space-y-4">${hist.slice().reverse().map(h => `<div class="bg-white p-5 rounded-[2rem] border border-[#F5E6D3] shadow-sm transition-all hover:border-[#8C7355]"><div class="flex justify-between items-start mb-2"><div><span class="text-xs font-black block text-gray-700 text-left">${h.date}</span><span class="text-[9px] text-[#C4B19E] block text-left">${h.location}</span></div><span class="text-xl font-black ${h.amount >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${h.amount >= 0 ? '+' : ''}${h.amount}</span></div><div class="text-[10px] bg-[#FBF8F5] p-2 rounded-xl text-center leading-none"><i data-lucide="users" size="12" class="text-[#8C7355] mr-1"></i> ${h.opponents.join('、')}</div></div>`).join('')}</div></div>`;
            } else {
                const allLocs = [...new Set(state.allSessions.map(s=>s.location||"未填寫"))].sort();
                container.innerHTML = `<div class="bg-[#FFFDFB] rounded-[3rem] p-8 border-8 border-white shadow-sm min-h-[60vh] animate-in"><div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-black text-[#4A3728]">麻將排行</h2><p class="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest">Ranking</p></div><select onchange="window.state.reportMonth=this.value; window.render()" class="bg-[#F5E6D3] rounded-xl text-xs font-black px-10 py-2.5 text-[#8C7355] border-none outline-none select-custom shadow-sm mr-2"><option value="total" ${state.reportMonth === 'total' ? 'selected' : ''}>全年度排行</option>${monthNames.map((m, i) => `<option value="${String(i + 1).padStart(2, '0')}" ${state.reportMonth === String(i + 1).padStart(2, '0') ? 'selected' : ''}>${m}</option>`).join('')}</select></div><div class="mb-8 overflow-hidden"><div class="flex items-center justify-between mb-2 px-1"><label class="text-[10px] font-black text-[#C4B19E] uppercase flex items-center gap-1.5"><i data-lucide="map-pin" size="12"></i> 篩選地點</label>${state.rankFilterLocations.length > 0 ? `<button onclick="window.clearRankFilter()" class="text-[9px] font-bold text-[#A64B4B] hover:underline">重置</button>` : ''}</div><div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">${allLocs.map(loc => `<button onclick="window.toggleLocationFilter('${loc}')" class="filter-chip shrink-0 px-4 py-2 rounded-2xl border-2 border-[#F5E6D3] bg-[#FBF8F5] text-[11px] font-black transition-all ${state.rankFilterLocations.includes(loc) ? 'active' : 'text-[#8C7355]'}">${loc}</button>`).join('')}</div></div><div class="space-y-3">${Object.entries(stats).map(([n, d]) => ({ name: n, ...d })).sort((a,b)=>b.net-a.net).map((p, idx) => `<div onclick="window.state.selectedPlayer='${p.name}'; window.state.detailMonth=window.state.reportMonth; window.switchView('report', false)" class="grid grid-cols-12 items-center px-4 py-5 rounded-[2rem] border-2 cursor-pointer transition-all active:scale-95 ${idx === 0 ? 'bg-[#F0EAD6]/40 border-[#8C7355]/20 shadow-sm' : 'bg-white border-transparent shadow-sm'}"><div class="col-span-6 flex items-center gap-2"><div class="w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-black ${idx === 0 ? 'bg-[#8C7355] text-white shadow-md' : 'bg-[#F5E6D3] text-[#8C7355]'}">${idx+1}</div><span class="font-black text-xs truncate text-[#4A3728]">${p.name}</span></div><div class="col-span-3 text-center text-xs font-black text-[#C4B19E]">${p.sessions} 場</div><div class="col-span-3 text-right font-black text-sm pr-6 ${p.net >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${p.net >= 0 ? '+' : ''}${p.net}</div></div>`).join('')}</div></div>`;
            }
            lucide.createIcons();
        };

        window.renderRedDotRank = (container) => {
            const ranks = window.calculateRedDotRanking();
            container.innerHTML = `<div class="bg-[#FFFDFB] rounded-[3rem] p-8 border-8 border-white shadow-sm min-h-[70vh] animate-in"><div class="flex justify-between items-center mb-8"><div><h2 class="text-xl font-black text-[#4A3728]">紅點排行</h2><p class="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest text-[#8C7355]">Leaderboard</p></div><div class="p-2 bg-[#F5E6D3] rounded-full text-[#8C7355] shadow-inner"><i data-lucide="award" size="20"></i></div></div><div class="space-y-3 px-1">${Object.entries(ranks).map(([n, d]) => ({ name: n, ...d })).sort((a, b) => b.net - a.net).map((p, idx) => `<div class="grid grid-cols-12 items-center px-4 py-5 rounded-[2rem] border-2 ${idx === 0 ? 'bg-[#F0EAD6]/40 border-[#8C7355]/20' : 'bg-white border-transparent shadow-sm'}"><div class="col-span-6 flex items-center gap-2"><div class="w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-black ${idx === 0 ? 'bg-[#8C7355] text-white' : 'bg-[#F5E6D3] text-[#8C7355]'}">${idx + 1}</div><span class="font-black text-xs truncate text-[#4A3728]">${p.name}</span></div><div class="col-span-3 text-center text-xs font-black text-[#C4B19E]">${p.sessions} 場</div><div class="col-span-3 text-right font-black text-sm pr-6 ${p.net >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${p.net >= 0 ? '+' : ''}${p.net}</div></div>`).join('')}</div></div>`;
            lucide.createIcons();
        };

        window.renderMemo = (container) => {
            container.innerHTML = `<div class="bg-[#FFFDFB] rounded-[3rem] p-8 border-8 border-white shadow-sm min-h-[70vh] flex flex-col animate-in"><div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-black flex items-center gap-2 text-[#4A3728]"><i data-lucide="book-open"></i> 備忘錄</h2><p class="text-[10px] font-bold text-[#C4B19E] uppercase tracking-widest text-[#8C7355]">Notes</p></div><button onclick="window.saveMemo()" id="memo-save-btn" class="bg-[#8C7355] text-white px-6 py-2.5 rounded-full text-xs font-black shadow-lg flex items-center gap-2 active:scale-95 transition-all hover:bg-[#5D4B37]"><i data-lucide="save" size="16"></i> 儲存變更</button></div><textarea id="memo-input" class="w-full flex-1 bg-[#FBF8F5] border-2 border-[#F5E6D3] rounded-[2rem] p-8 text-sm font-medium leading-relaxed outline-none resize-none focus:ring-2 focus:ring-[#8C7355]/20 shadow-inner text-center" placeholder="在此輸入筆記...">${state.memoData}</textarea></div>`;
            lucide.createIcons();
        };

        // --- 3. 核心：主渲染控制 ---

        window.render = () => {
            const container = document.getElementById('view-container'); if (!container) return;
            container.innerHTML = '';
            if (state.view === 'home') window.renderHome(container);
            else if (state.view === 'calendar') window.renderCalendar(container);
            else if (state.view === 'report') window.renderReport(container);
            else if (state.view === 'reddot') window.renderRedDot(container);
            else if (state.view === 'reddot_rank') window.renderRedDotRank(container);
            else if (state.view === 'memo') window.renderMemo(container);
            
            // 底部按鈕高亮
            ['home', 'calendar', 'report', 'reddot', 'reddot_rank', 'memo'].forEach(id => {
                const btn = document.getElementById(`nav-${id}`); if (!btn) return;
                if (state.view === id) { btn.classList.add('text-[#8C7355]', 'scale-110'); btn.classList.remove('text-[#D9C5B2]'); }
                else { btn.classList.remove('text-[#8C7355]', 'scale-110'); btn.classList.add('text-[#D9C5B2]'); }
            });
        };

        // --- 4. 彈窗與互動動作 (核心修正：移除 confirm 改用 UI 反饋) ---

        window.openModal = (ds) => {
            state.selectedDateStr = ds; const ex = state.allSessions.filter(s => s.date === ds);
            state.editingSessions = ex.length > 0 ? JSON.parse(JSON.stringify(ex)) : [{ id: "new_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5), date: ds, stakes: '30/10', location: '', rounds: 1, note: '', players: [{ name: NAME_1, amount: 0 }, { name: NAME_2, amount: 0 }, { name: '對手A', amount: 0 }, { name: '對手B', amount: 0 }] }];
            window.renderModal(); document.getElementById('modal-root').classList.remove('hidden');
        };

        window.renderModal = () => {
            const modalContent = document.getElementById('modal-content'); const game = state.editingSessions; if (!game) return;
            const sm = {}; game.forEach(s => s.players.forEach(p => { const n = p.name.trim(); if (n) { sm[n] = (sm[n] || 0) + Number(p.amount); } }));
            modalContent.innerHTML = `<div class="p-6 border-b border-[#F5E6D3] flex justify-between items-center bg-white shadow-sm"><div class="flex items-center gap-3"><div class="p-2 bg-[#F5E6D3] rounded-full text-[#8C7355] shadow-inner"><i data-lucide="calendar-days" size="20"></i></div><h3 class="text-xl font-black text-[#4A3728]">${state.selectedDateStr} 管理</h3></div><div class="flex gap-2"><button onclick="window.addSessionToEdit()" class="bg-[#A67B5B] text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-md font-black text-2xl active:scale-90 transition-all">+</button><button onclick="window.closeModal()" class="bg-[#F5E6D3] p-2 rounded-full text-[#8C7355] active:scale-90 shadow-sm"><i data-lucide="x" size="20"></i></button></div></div><div class="flex-1 overflow-y-auto p-4 space-y-6 bg-[#FBF8F5] no-scrollbar"><div class="bg-white rounded-[2rem] p-6 border-2 border-[#8C7355]/20 shadow-sm"><div class="flex items-center gap-2 mb-4 text-[#8C7355]"><i data-lucide="pie-chart" class="w-4"></i><h4 class="text-sm font-black uppercase tracking-wider text-sm leading-none">戰績快報</h4></div><div class="grid grid-cols-2 sm:grid-cols-4 gap-3">${Object.entries(sm).map(([n, d]) => `<div class="bg-[#FBF8F5] p-3 rounded-2xl border border-[#F5E6D3] text-center shadow-sm"><span class="text-[9px] font-black text-[#C4B19E] block uppercase mb-1 leading-none text-center">${n}</span><span class="text-sm font-black ${d >= 0 ? 'text-[#8C7355]' : 'text-[#A64B4B]'}">${d >= 0 ? '+' : ''}${d}</span></div>`).join('')}</div></div>${game.map((s, sIdx) => { const bal = s.players.reduce((a, b) => a + (Number(b.amount) || 0), 0); return `<div class="bg-white rounded-[2rem] p-6 border-2 border-[#8C7355]/30 relative shadow-sm transition-all animate-in"><button onclick="window.deleteSessionImmediate('${s.id}')" class="absolute -top-3 -right-3 bg-white text-rose-500 p-2.5 rounded-full shadow-lg border border-rose-100 active:scale-90"><i data-lucide="trash-2" size="18"></i></button><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div><label class="text-[10px] font-black text-[#C4B19E] block mb-1 text-center text-[#8C7355] uppercase">日期</label><input type="date" value="${s.date}" onchange="window.updateSession(${sIdx}, 'date', this.value)" class="w-full bg-[#F5E6D3]/30 border-none rounded-xl px-4 py-2 text-xs font-black text-center text-[#8C7355]"></div><div><label class="text-[10px] font-black text-[#C4B19E] block mb-1 text-center text-[#8C7355] uppercase">地點</label><input type="text" value="${s.location}" onchange="window.updateSession(${sIdx}, 'location', this.value)" class="w-full bg-[#F5E6D3]/30 border-none rounded-xl px-4 py-2 text-xs font-black text-center" placeholder="在哪打？"></div><div><label class="text-[10px] font-black text-[#C4B19E] block mb-1 text-center text-[#8C7355] uppercase">底/台</label><input type="text" value="${s.stakes}" onchange="window.updateSession(${sIdx}, 'stakes', this.value)" class="w-full bg-[#F5E6D3]/30 border-none rounded-xl px-4 py-2 text-xs font-black text-center"></div><div><label class="text-[10px] font-black text-[#C4B19E] block mb-1 text-center text-[#8C7355] uppercase">將數</label><input type="number" value="${s.rounds}" onchange="window.updateSession(${sIdx}, 'rounds', this.value)" class="w-full bg-[#F5E6D3]/30 border-none rounded-xl px-4 py-2 text-xs font-black text-center"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">${s.players.map((p, pIdx) => `<div class="flex items-center justify-center gap-4 p-3 rounded-2xl border-2 ${pIdx < 2 ? 'bg-[#F5E6D3]/10 border-[#F5E6D3]/50' : 'bg-[#FBF8F5] border-transparent shadow-inner'}"><input type="text" value="${p.name}" onchange="window.updatePlayer(${sIdx}, ${pIdx}, 'name', this.value)" class="w-16 bg-transparent border-none text-xs font-black outline-none text-[#4A3728] text-center" placeholder="姓名"><div onclick="window.openCalculator({type:'mahjong', sIdx:${sIdx}, pIdx:${pIdx}})" class="w-24 bg-white px-3 py-1.5 rounded-xl border border-gray-100 flex items-center justify-center shadow-sm cursor-pointer active:scale-95 transition-all text-center"><span class="text-[10px] text-[#C4B19E] mr-1">$</span><span class="text-xs font-black ${p.amount>=0?'text-[#8C7355]':'text-[#A64B4B]'}">${p.amount}</span></div></div>`).join('')}</div><div class="flex items-center justify-between mt-4 pt-4 border-t border-[#F5E6D3]"><div class="px-6 py-2 rounded-full inline-flex items-center gap-2 text-[10px] font-black ${bal === 0 ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-rose-50 text-rose-500 border border-rose-100'}"><i data-lucide="${bal === 0 ? 'check-circle-2' : 'alert-circle'}" size="14"></i><span>核算：${bal}</span></div>${!s.note ? `<button onclick="window.updateSession(${sIdx}, 'note', ' ')" class="text-[10px] font-black text-[#8C7355] flex items-center gap-1 hover:underline"><i data-lucide="plus-circle" size="14"></i> 筆記</button>` : ''}</div>${s.note ? `<div class="mt-4 animate-in"><textarea onchange="window.updateSession(${sIdx}, 'note', this.value)" class="w-full bg-[#F5E6D3]/20 border-2 border-dashed border-[#F5E6D3] rounded-2xl p-4 text-[11px] font-medium resize-none h-20 outline-none text-center" placeholder="在此輸入筆記...">${s.note.trim()}</textarea></div>` : ''}</div>`; }).join('')}</div><div class="p-4 bg-white border-t border-[#F5E6D3] shadow-lg"><button onclick="window.saveToCloud()" id="modal-save-btn" class="w-full py-4 bg-[#8C7355] text-white rounded-[2rem] font-black shadow-lg flex items-center justify-center gap-3 transition-all active:scale-[0.98] transform hover:translate-y-[-1px]"><i data-lucide="save" size="20"></i> 儲存變更</button></div>`;
            lucide.createIcons();
        };

        window.saveToCloud = async () => {
            if (!state.user) return;
            const btn = document.getElementById('modal-save-btn');
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5"></i> 儲存中...';
            lucide.createIcons();
            try {
                for (const s of state.editingSessions) {
                    if (state.deletedIds.has(s.id)) continue;
                    const { id, ...rest } = s;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id), cleanData(rest));
                }
                window.closeModal(); window.showToast("資料已儲存");
            } catch (e) { window.showToast("儲存失敗"); console.error(e); }
            btn.disabled = false; btn.innerHTML = '<i data-lucide="save" class="w-5"></i> 儲存變更';
            lucide.createIcons();
        };

        window.renderRedDotModal = () => {
            const modalContent = document.getElementById('modal-content'); const game = state.editingRedDot; if (!game) return;
            const total = game.players.reduce((s, p) => s + (Number(p.amount) || 0), 0);
            modalContent.innerHTML = `<div class="p-6 border-b border-[#F5E6D3] flex justify-between items-center bg-white shadow-sm"><div class="flex items-center gap-3"><div class="p-2 bg-[#F5E6D3] rounded-full text-[#8C7355] shadow-inner"><i data-lucide="gamepad-2" size="20"></i></div><h3 class="text-lg font-black text-[#4A3728]">紅點盈虧結算</h3></div><div class="flex gap-2"><button onclick="window.saveRedDotToCloud()" id="rd-save-btn" class="bg-[#8C7355] text-white px-4 py-2 rounded-xl shadow-md text-xs font-black flex items-center gap-2 active:scale-95 transition-all"><i data-lucide="save" size="14"></i> 儲存</button><button onclick="window.closeModal()" class="bg-[#F5E6D3] p-2 rounded-full text-[#8C7355] active:scale-90 shadow-sm"><i data-lucide="x" size="20"></i></button></div></div><div class="flex-1 overflow-y-auto bg-[#FBF8F5] p-4 sm:p-6 space-y-6 no-scrollbar text-center"><div class="bg-white p-6 rounded-[2.5rem] border-2 border-[#F5E6D3] shadow-sm space-y-4 text-center"><div class="flex flex-col sm:flex-row gap-4 items-center justify-center"><div class="w-full sm:w-auto flex flex-col items-center"><label class="text-[10px] font-black text-[#C4B19E] block mb-1 uppercase tracking-widest leading-none">日期</label><input type="date" value="${game.date}" onchange="window.state.editingRedDot.date=this.value; window.renderRedDotModal();" class="w-full max-w-[130px] bg-[#FBF8F5] border-none rounded-xl px-4 py-2.5 text-xs font-black shadow-inner text-center text-[#8C7355]"></div><div class="w-full sm:w-auto flex flex-col items-center"><label class="text-[10px] font-black text-[#C4B19E] block mb-1 uppercase tracking-widest leading-none text-center">合計 (應為0)</label><div class="px-6 py-2.5 rounded-xl border-2 font-black text-xs text-center min-w-[130px] ${total === 0 ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-500 border-rose-100'}">加總：${total}</div></div></div><div><label class="text-[10px] font-black text-[#C4B19E] block mb-2 uppercase tracking-widest leading-none text-center">快速選人</label><div class="flex flex-wrap gap-2 justify-center">${RED_DOT_PRESETS.map(n => `<button onclick="window.toggleRedDotPlayer('${n}')" class="player-preset-btn px-4 py-2 rounded-xl border-2 border-[#F5E6D3] bg-[#FBF8F5] text-[11px] font-black transition-all ${game.players.some(p => p.name === n) ? 'active' : 'text-[#8C7355]'}">${n}</button>`).join('')}</div></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${game.players.map((p, i) => `<div class="bg-white p-4 rounded-[2rem] border-2 border-[#F5E6D3] flex flex-col items-center gap-3 shadow-sm transition-all hover:border-[#8C7355]"><div class="w-full flex items-center justify-center gap-2 text-[#4A3728] font-black text-center leading-none"><input type="text" value="${p.name}" onchange="window.updateRedDotPlayerName(${i}, this.value)" class="w-24 bg-transparent border-b-2 border-dashed border-[#F5E6D3] text-center text-sm outline-none placeholder-gray-300 text-center"><button onclick="window.removeRedDotPlayer(${i})" class="text-[#A64B4B] p-1 active:scale-125 transition-all shadow-none border-none bg-transparent"><i data-lucide="trash-2" size="16"></i></button></div><div onclick="window.openCalculator({type:'reddot', pIdx:${i}})" class="bg-[#FBF8F5] px-6 py-3 rounded-2xl flex items-center justify-center shadow-inner text-[#8C7355] w-full max-w-[140px] cursor-pointer active:scale-95 transition-all text-center"><span class="text-[10px] text-[#C4B19E] mr-2">$</span><span class="text-lg font-black">${p.amount}</span></div></div>`).join('')}${game.players.length < 4 ? `<button onclick="window.addBlankRedDotPlayer()" class="bg-white p-4 rounded-[2rem] border-2 border-dashed border-[#C4B19E] flex items-center justify-center text-[#C4B19E] text-xs font-black gap-2 hover:border-[#8C7355] hover:text-[#8C7355] transition-all min-h-[110px]"><i data-lucide="user-plus" size="18"></i> 新增玩家</button>` : ''}</div><div class="text-center pt-4"><button onclick="window.deleteRedDotSession()" class="text-[#A64B4B] text-[11px] font-black flex items-center gap-1 mx-auto hover:underline transition-all"><i data-lucide="trash-2" size="14"></i> 刪除此對局紀錄</button></div></div>`;
            lucide.createIcons();
            document.getElementById('modal-root').classList.remove('hidden');
        };

        window.saveRedDotToCloud = async () => {
            const g = state.editingRedDot; if (!g) return;
            const btn = document.getElementById('rd-save-btn');
            btn.disabled = true;
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reddot_sessions_v2', g.id), cleanData(g)); window.showToast("紅點紀錄已儲存"); window.closeModal(); } catch (e) { window.showToast("儲存失敗"); }
            btn.disabled = false;
        };

        window.openToday = () => { const t = new Date(); const ds = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; if (state.view === 'reddot' || state.view === 'reddot_rank') window.createNewRedDot(); else window.openModal(ds); };
        window.createNewRedDot = () => { const t = new Date(); state.editingRedDot = { id: "rd_" + Date.now(), date: `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`, players: [{name: NAME_1, amount: 0}, {name: NAME_2, amount: 0}] }; window.renderRedDotModal(); };
        window.addSessionToEdit = () => { state.editingSessions.push({ id: "new_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5), date: state.selectedDateStr, stakes: '30/10', location: '', rounds: 1, note: '', players: [{ name: NAME_1, amount: 0 }, { name: NAME_2, amount: 0 }, { name: '對手A', amount: 0 }, { name: '對手B', amount: 0 }] }); window.renderModal(); };
        window.updateSession = (i, k, v) => { state.editingSessions[i][k] = v; window.renderModal(); };
        window.updatePlayer = (i, pi, k, v) => { state.editingSessions[i].players[pi][k] = v; window.renderModal(); };
        window.deleteSessionImmediate = async (id) => { if (!state.user) return; const isCloud = state.allSessions.some(s => s.id === id); if (!isCloud) { state.editingSessions = state.editingSessions.filter(s => s.id !== id); window.renderModal(); return; } state.deletedIds.add(id); state.editingSessions = state.editingSessions.filter(s => s.id !== id); window.renderModal(); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id)); showToast("已刪除紀錄"); } catch (e) { state.deletedIds.delete(id); } };
        window.deleteRedDotSession = async () => { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reddot_sessions_v2', state.editingRedDot.id)); window.showToast("已刪除"); window.closeModal(); } catch (e) { window.showToast("刪除失敗"); } };
        window.updateRedDotPlayerName = (i, v) => { state.editingRedDot.players[i].name = v; window.renderRedDotModal(); };
        window.removeRedDotPlayer = (i) => { state.editingRedDot.players.splice(i, 1); window.renderRedDotModal(); };
        window.addBlankRedDotPlayer = () => { state.editingRedDot.players.push({name: "", amount: 0}); window.renderRedDotModal(); };
        window.toggleRedDotPlayer = (n) => { const g = state.editingRedDot; if (!g) return; const idx = g.players.findIndex(p => p.name === n); if (idx > -1) g.players.splice(idx, 1); else if (g.players.length < 4) g.players.push({name: n, amount: 0}); else window.showToast("最多 4 人"); window.renderRedDotModal(); };
        window.editRedDot = (id) => { const s = state.redDotSessions.find(x => x.id === id); if (s) { state.editingRedDot = JSON.parse(JSON.stringify(s)); window.renderRedDotModal(); } };
        window.saveMemo = async () => { if (!state.user) return; const b = document.getElementById('memo-save-btn'); b.disabled = true; b.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4"></i>'; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_memo', 'global_memo'), { content: document.getElementById('memo-input').value, updatedAt: Date.now() }); window.showToast("已儲存"); } catch (e) {} b.disabled = false; b.innerHTML = '<i data-lucide="save" size="16"></i> 儲存變更'; lucide.createIcons(); };
        window.handleRestore = async () => { if (!state.user) return; document.getElementById('loading-overlay').classList.remove('hidden'); try { const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'backups', 'last_state')); if (snap.exists()) { const data = JSON.parse(snap.data().content); const curS = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'sessions')); for (const d of curS.docs) await deleteDoc(d.ref); for (const s of data) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', s.id), cleanData(s)); window.showToast("還原完成"); } } catch (e) {} document.getElementById('loading-overlay').classList.add('hidden'); };
        window.exportData = () => { const blob = new Blob([JSON.stringify({ sessions: state.allSessions, redDot: state.redDotSessions })], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mahjong_diary_2026.json`; a.click(); };
        window.exportExcel = (type) => { let d = []; let f = (type === 'mahjong') ? "2026_麻將紀錄.xlsx" : "2026_紅點紀錄.xlsx"; if (type === 'mahjong') { d = state.allSessions.map(s => { const row = { "日期": s.date, "地點": s.location, "底台": s.stakes, "將數": s.rounds }; s.players.forEach((p, idx) => { row[`玩家${idx+1}`] = p.name; row[`金額${idx+1}`] = p.amount; }); return row; }); } else { d = state.redDotSessions.map(s => { const row = { "日期": s.date }; s.players.forEach((p, idx) => { row[`玩家${idx+1}`] = p.name; row[`金額${idx+1}`] = p.amount; }); return row; }); } if (!d.length) return window.showToast("無資料可匯出"); const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Log"); XLSX.writeFile(wb, f); window.showToast("Excel 匯出成功"); };
        window.toggleLocationFilter = (n) => { const i = state.rankFilterLocations.indexOf(n); if (i > -1) state.rankFilterLocations.splice(i, 1); else state.rankFilterLocations.push(n); window.render(); };
        window.clearRankFilter = () => { state.rankFilterLocations = []; window.render(); };

        // --- 5. 初始化驗證與啟動 ---

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else { await signInAnonymously(auth); }
            } catch (e) { await signInAnonymously(auth); }
            setTimeout(() => { document.getElementById('loading-overlay').classList.add('hidden'); window.render(); }, 1000);
        }

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sessions'), (snap) => {
                    const d = []; snap.forEach(s => { if (!state.deletedIds.has(s.id)) d.push({ id: s.id, ...s.data() }); });
                    d.sort((a, b) => b.date.localeCompare(a.date)); state.allSessions = d; window.render();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reddot_sessions_v2'), (snap) => {
                    const d = []; snap.forEach(s => d.push({ id: s.id, ...s.data() }));
                    d.sort((a, b) => b.date.localeCompare(a.date)); state.redDotSessions = d; window.render();
                });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'app_memo', 'global_memo'), (s) => { 
                    if (s.exists()) state.memoData = s.data().content; if (state.view === 'memo') window.render(); 
                });
            }
        });

        initAuth();
    </script>
</body>
</html>
